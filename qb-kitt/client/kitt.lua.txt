local started, warned, turboUsed = false, false, false
local lastChatter, lastScanner = 0, 0
local enabled = true -- respects server toggle

local function playKittSound(name)
    if enabled then
        TriggerServerEvent('InteractSound_SV:PlayOnSource', name, 0.5)
    end
end

-- Listen for server toggle
RegisterNetEvent('qb-kitt:client:setEnabled', function(state)
    enabled = state
end)

-- Scanner light effect
local function scannerEffect(veh)
    if not Config.EnableScannerEffect then return end
    local coords = GetEntityCoords(veh)
    local offset = 0.0
    for i = 1, 10 do
        DrawLightWithRange(coords.x + offset, coords.y + 2.0, coords.z + 0.5, 255, 0, 0, 2.0, 50.0)
        offset = offset + 0.2
        Wait(50)
    end
end

CreateThread(function()
    while true do
        Wait(1000)
        local ped = PlayerPedId()
        local veh = GetVehiclePedIsIn(ped, false)

        if enabled and veh ~= 0 and GetEntityModel(veh) == Config.KITTModel then
            -- Engine start
            if Config.EnableEngineStartLine and IsVehicleEngineOn(veh) and not started then
                playKittSound(Config.VoiceLines.engineStart)
                started = true
            end

            -- Damage check
            if Config.EnableDamageLine and GetVehicleEngineHealth(veh) < 800 and not warned then
                playKittSound(Config.VoiceLines.damage)
                warned = true
            end

            -- Turbo boost
            if Config.EnableTurboLine and IsControlJustPressed(0, Config.TurboKey) and not turboUsed then
                playKittSound(Config.VoiceLines.turbo)
                turboUsed = true
                local pos = GetEntityCoords(veh)
                SetEntityCoords(veh, pos.x, pos.y + 20.0, pos.z + 2.0, false, false, false, false)
                CreateThread(function()
                    Wait(Config.TurboCooldown * 1000)
                    turboUsed = false
                end)
            end

            -- Random chatter
            if Config.EnableRandomChatter and (GetGameTimer() - lastChatter) > (Config.ChatterInterval * 1000) then
                local lines = Config.VoiceLines.chatter
                playKittSound(lines[math.random(1, #lines)])
                lastChatter = GetGameTimer()
            end

            -- Scanner effect + sound
            if Config.EnableScannerEffect and (GetGameTimer() - lastScanner) > (Config.ScannerInterval * 1000) then
                playKittSound(Config.VoiceLines.scanner)
                scannerEffect(veh)
                lastScanner = GetGameTimer()
            end
        else
            started, warned, turboUsed = false, false, false
        end
    end
end)
